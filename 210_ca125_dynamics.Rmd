---
title: "CA-125 dynamics"
subtitle: "MSK SPECTRUM"
author:
  - "Ignacio Vazquez-Garcia"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    highlight: tango
    df_print: paged
    code_folding: hide
    fig_align: center
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: yes
params:
   rmd: "210_ca125_dynamics.Rmd"
---

```{r setup, include=FALSE}
# Global knit options
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

# Global chunk options
knitr::opts_chunk$set(echo=FALSE, tidy=TRUE, warning=FALSE, message=FALSE)
```

```{r, include=FALSE}
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(ggrepel)
library(cowplot)
library(scales)
library(lubridate)

source("src/global_vars.R")

db <- db %>%
  map(~mutate(.x, patient_id_short = str_remove_all(patient_id, "SPECTRUM-OV-")))
```

## Laboratory tests

```{r}
db$laboratory_tests %>% 
  count(laboratory_test_subname) %>% 
  arrange(desc(n))
```

```{r, fig.width=7, fig.height=17}

p <- db$laboratory_tests %>%
  filter(patient_id %in% included_patients) %>%
  group_by(patient_id, laboratory_test_name) %>%
  arrange(laboratory_test_date) %>%
  dplyr::mutate(laboratory_test_date_diff = laboratory_test_date - first(laboratory_test_date)) %>%
  ggplot() +
  aes(x=laboratory_test_date_diff, y=reorder(patient_id_short, desc(patient_id)), col=laboratory_test_name, label=laboratory_test_name) +
  geom_point(size=1) +
  scale_x_continuous(breaks = scales::breaks_width(365)) +
  labs(x = "Time from baseline (days)", y = "Patients") +
  theme(
    legend.position="none",
    panel.grid.major=element_blank()
  )

p

```

## Tumor markers

We have gathered laboratory test results for prognostic biomarkers of high-grade serous ovarian cancer (e.g. CA-125, CEA, CA-99). We plot these biomarker levels longitudinally for each patient. CA-125 is collected for the majority of patients, and CEA/CA-99 are often collected as broader cancer biomarkers.

### CA-125 time series

We can focus on patients who looks to have increasing CA-125 values, which suggest a potential relapse of the disease.

```{r}

biomarkers_tbl <- db$laboratory_tests %>% 
  dplyr::filter(patient_id %in% included_patients,
                laboratory_test_name %in% c("Cancer Antigen 125 (CA 125)")) %>% 
  group_by(patient_id) %>%
  dplyr::arrange(laboratory_test_date) %>%
  dplyr::mutate(
    laboratory_test_date_diff = laboratory_test_date - first(laboratory_test_date),
    laboratory_test_date = as.numeric(laboratory_test_date, units = "days"),
    laboratory_test_date_diff = as.numeric(laboratory_test_date_diff, units = "days")
    ) %>%
  dplyr::filter(laboratory_test_date_diff > 0 & !is.na(laboratory_test_date_diff)) %>%
  dplyr::mutate(
    laboratory_test_biomarker_level = as.numeric(laboratory_test_biomarker_level),
    laboratory_test_biomarker_level_baseline = laboratory_test_biomarker_level - first(laboratory_test_biomarker_level),
    laboratory_test_biomarker_level_diff = laboratory_test_biomarker_level - lag(laboratory_test_biomarker_level),
    laboratory_test_biomarker_level_minimum = rank(laboratory_test_biomarker_level, ties.method="first")==1,
    laboratory_test_biomarker_level_after_minimum = if_else(row_number() > which.min(laboratory_test_biomarker_level), "After min CA 125", "Before min CA 125")
    ) %>%
  ungroup

```

#### All patients

```{r fig.height = 16, fig.width = 16}

p <- biomarkers_tbl %>%
  ggplot() +
  aes(x=laboratory_test_date_diff, y=as.numeric(laboratory_test_biomarker_level)) +
  geom_line(color = "grey10") +
  geom_point(aes(color=laboratory_test_biomarker_level_after_minimum), size=0.75) +
  # geom_vline(data = response_tbl, aes(xintercept = response_first_recurrence_ct_scan_date)) +
  scale_x_continuous(breaks = scales::breaks_width(365)) +
  scale_y_log10(breaks = 10^(-1:10),
                labels = trans_format("log10", math_format(10^.x))) +
  labs(title=unique(biomarkers_tbl$laboratory_test_name), 
       x='Time from baseline (days)', y=unique(biomarkers_tbl$laboratory_test_biomarker_units), 
       color='') +
  theme(plot.title = element_text(size=14),
        panel.grid.major.x = element_line(size=.1, color="grey50", linetype = "dashed"),
        panel.grid.major.y = element_line(size=.1, color="grey50", linetype = "dashed")) +
  facet_wrap(glue::glue("{patient_id_short}") ~ .)

p

ggsave_pdf("figures/210_ca125_dynamics/001_ca125_time_series_all_patients.pdf",
           p, width = 16, height = 16)
ggsave_png("figures/210_ca125_dynamics/001_ca125_time_series_all_patients.png",
           p, width = 16, height = 16)

```

#### scDNA patients

```{r fig.height = 10, fig.width = 12}

p <- biomarkers_tbl %>%
  filter(patient_id %in% scdna_patients) %>%
  ggplot() +
  aes(x=laboratory_test_date_diff, y=as.numeric(laboratory_test_biomarker_level)) +
  geom_line(color = "grey10") +
  geom_point(aes(color=laboratory_test_biomarker_level_after_minimum), size=0.75) +
  scale_x_continuous(breaks = scales::breaks_width(365)) +
  scale_y_log10(breaks = 10^(-1:10),
                labels = trans_format("log10", math_format(10^.x))) +
  labs(title=unique(biomarkers_tbl$laboratory_test_name), 
       x='Time from baseline (days)', y=unique(biomarkers_tbl$laboratory_test_biomarker_units), 
       color='') +
  theme(plot.title = element_text(size=14),
        panel.grid.major.x = element_line(size=.1, color="grey50", linetype = "dashed"),
        panel.grid.major.y = element_line(size=.1, color="grey50", linetype = "dashed")) +
  facet_wrap(glue::glue("{patient_id_short}") ~ .)

p

ggsave_pdf("figures/210_ca125_dynamics/001_ca125_time_series_scdna_patients.pdf",
           p, width = 16, height = 16)
ggsave_png("figures/210_ca125_dynamics/001_ca125_time_series_scdna_patients.png",
           p, width = 16, height = 16)

```