---
title: "cfDNA dynamics"
subtitle: "MSK SPECTRUM"
author:
  - "Ignacio Vazquez-Garcia"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    highlight: tango
    df_print: paged
    code_folding: hide
    fig_align: center
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: yes
params:
   rmd: "220_cfdna_dynamics.Rmd"
---

```{r setup, include=FALSE}
# Global knit options
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

# Global chunk options
knitr::opts_chunk$set(echo=FALSE, tidy=TRUE, warning=FALSE, message=FALSE)
```

```{r, include=FALSE}
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(ggrepel)
library(cowplot)
library(scales)
library(lubridate)

source("src/global_vars.R")
source("src/plot_inventory_heatmap.R")
source("src/plot_oncoprint_heatmap.R")

db <- db %>%
  map(~mutate(.x, patient_id_short = str_remove_all(patient_id, "SPECTRUM-OV-")))
```

## cfDNA time series

### All patients

```{r, fig.width=9, fig.height=17}

p <- db$specimens_lab_medicine %>%
  filter(patient_id %in% included_patients) %>%
  group_by(patient_id, specimen_lab_medicine_status) %>%
  arrange(specimen_lab_medicine_collection_date) %>%
  dplyr::mutate(specimen_lab_medicine_collection_date_diff = specimen_lab_medicine_collection_date - first(specimen_lab_medicine_collection_date)) %>%
  ggplot() +
  aes(x=specimen_lab_medicine_collection_date_diff, y=reorder(patient_id_short, desc(patient_id)), 
      col=specimen_lab_medicine_status, label=specimen_lab_medicine_status, size=specimen_lab_medicine_cfdna_total_yield) +
  geom_point(alpha = 0.5) +
  scale_x_continuous(breaks = scales::breaks_width(365)) +
  labs(title = "Plasma/buffy coat samples", x = "Time from baseline (days)", y = "Patients",
       color = "Sample type", size = "cfDNA total yield") +
  theme(
    legend.position="right",
    panel.grid.major.x = element_line(size=.1, color="grey50", linetype = "dashed")
  )

p

```


### Patients with scDNA

```{r, fig.width=9, fig.height=6}

p <- db$specimens_lab_medicine %>%
  filter(patient_id %in% scdna_patients) %>%
  group_by(patient_id, specimen_lab_medicine_status) %>%
  arrange(specimen_lab_medicine_collection_date) %>%
  dplyr::mutate(specimen_lab_medicine_collection_date_diff = specimen_lab_medicine_collection_date - first(specimen_lab_medicine_collection_date)) %>%
  ggplot() +
  aes(x=specimen_lab_medicine_collection_date_diff, y=reorder(patient_id_short, desc(patient_id)), 
      col=specimen_lab_medicine_status, label=specimen_lab_medicine_status, size=specimen_lab_medicine_cfdna_total_yield) +
  geom_point(alpha = 0.5) +
  scale_x_continuous(breaks = scales::breaks_width(365)) +
  labs(title = "Plasma/buffy coat samples", x = "Time from baseline (days)", y = "Patients",
       color = "Sample type", size = "cfDNA total yield") +
  theme(
    legend.position="right",
    panel.grid.major.x = element_line(size=.1, color="grey50", linetype = "dashed")
  )

p

```